<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hserus 2</title>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #fff; text-align: center; }
    table { border-collapse: collapse; margin: 20px auto; width: 95%; }
    th, td { border: 1px solid #444; padding: 8px; font-size: 14px; }
    th { cursor: pointer; background: #222; }
    tr:nth-child(even) { background: #1e1e1e; }
    .green { color: #0f0; }
    .red { color: #f00; }
  </style>
</head>
<body>
  <h2>Hserus 2</h2>
  <p id="status">Fetching data...</p>
  <table id="results">
    <thead>
      <tr>
        <th>Symbol</th>
        <th onclick="sortTable('currChange')">% Change (Current)</th>
        <th onclick="sortTable('prevChange')">% Change (Prev)</th>
        <th>RSI(6)</th>
        <th>MACD Hist</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const tableBody = document.querySelector("#results tbody");
const statusEl = document.getElementById("status");
let dataList = [];
let sortKey = 'currChange';
let sortAsc = false;

async function fetchSymbols() {
  let res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
  let json = await res.json();
  return json.symbols
    .filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s => s.symbol);
}

function calcRSI(closes, length = 6) {
  let gains = 0, losses = 0;
  for (let i = 1; i <= length; i++) {
    let diff = closes[i] - closes[i-1];
    if (diff > 0) gains += diff;
    else losses -= diff;
  }
  let rs = gains / length / (losses / length || 1);
  return 100 - (100 / (1 + rs));
}

function calcMACD(closes, fast=12, slow=26, signal=9) {
  const ema = (period, data) => {
    let k = 2 / (period + 1);
    return data.reduce((acc, val, i) => {
      if (i === 0) acc.push(val);
      else acc.push(val * k + acc[i-1] * (1 - k));
      return acc;
    }, []);
  };
  let emaFast = ema(fast, closes);
  let emaSlow = ema(slow, closes);
  let macdLine = emaFast.map((v, i) => v - emaSlow[i]);
  let signalLine = ema(signal, macdLine);
  let hist = macdLine.map((v, i) => v - signalLine[i]);
  return hist;
}

async function fetchData() {
  statusEl.textContent = "Scanning...";
  let symbols = await fetchSymbols();
  let results = [];
  let count = 0;

  for (let symbol of symbols) {
    count++;
    statusEl.textContent = `Scanning ${count}/${symbols.length}`;

    let klines = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=100`);
    let data = await klines.json();
    let closes = data.map(d => parseFloat(d[4]));
    let opens = data.map(d => parseFloat(d[1]));
    let hist = calcMACD(closes);
    let rsi = calcRSI(closes.slice(-7));

    let last = data[data.length-1];
    let prev = data[data.length-2];

    let lastOpen = parseFloat(last[1]);
    let lastClose = parseFloat(last[4]);
    let prevOpen = parseFloat(prev[1]);
    let prevClose = parseFloat(prev[4]);

    let lastColor = lastClose > lastOpen ? 'green' : (lastClose < lastOpen ? 'red' : 'doji');
    let prevColor = prevClose > prevOpen ? 'green' : (prevClose < prevOpen ? 'red' : 'doji');

    let currChange = ((lastClose - lastOpen) / lastOpen * 100).toFixed(2);
    let prevChange = ((prevClose - prevOpen) / prevOpen * 100).toFixed(2);

    // MACD condition check
    let h1 = hist[hist.length-1];
    let h2 = hist[hist.length-2];
    let h3 = hist[hist.length-3];

    let valid = false;
    if (lastColor !== 'doji' && prevColor !== 'doji' && lastColor !== prevColor) {
      if (lastColor === 'red' && h3 < h2 && h2 < h1) valid = true;
      if (lastColor === 'green' && h3 > h2 && h2 > h1) valid = true;
    }

    if (valid) {
      results.push({
        symbol,
        currChange: parseFloat(currChange),
        prevChange: parseFloat(prevChange),
        rsi: rsi.toFixed(2),
        hist: h1.toFixed(4)
      });
    }
  }
  dataList = results;
  renderTable();
}

function renderTable() {
  tableBody.innerHTML = "";
  let sorted = [...dataList].sort((a, b) => sortAsc ? a[sortKey] - b[sortKey] : b[sortKey] - a[sortKey]);
  sorted.forEach(row => {
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.symbol}</td>
      <td class="${row.currChange >= 0 ? 'green' : 'red'}">${row.currChange}%</td>
      <td class="${row.prevChange >= 0 ? 'green' : 'red'}">${row.prevChange}%</td>
      <td>${row.rsi}</td>
      <td>${row.hist}</td>
    `;
    tableBody.appendChild(tr);
  });
}

function sortTable(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = false; }
  renderTable();
}

fetchData();
</script>
</body>
</html>
